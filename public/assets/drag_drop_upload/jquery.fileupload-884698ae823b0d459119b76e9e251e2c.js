/*
 * jQuery File Upload Plugin 5.12
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
/*jslint nomen: true, unparam: true, regexp: true */
/*global define, window, document, Blob, FormData, location */
(function(e){"use strict";typeof define=="function"&&define.amd?define(["jquery","jquery.ui.widget"],e):e(window.jQuery)})(function(e){"use strict";e.support.xhrFileUpload=!!window.XMLHttpRequestUpload&&!!window.FileReader,e.support.xhrFormDataFileUpload=!!window.FormData,e.widget("blueimp.fileupload",{options:{namespace:undefined,dropZone:e(document),fileInput:undefined,replaceFileInput:!0,paramName:undefined,singleFileUploads:!0,limitMultiFileUploads:undefined,sequentialUploads:!1,limitConcurrentUploads:undefined,forceIframeTransport:!1,redirect:undefined,redirectParamName:undefined,postMessage:undefined,multipart:!0,maxChunkSize:undefined,uploadedBytes:undefined,recalculateProgress:!0,progressInterval:100,bitrateInterval:500,formData:function(e){return e.serializeArray()},add:function(e,t){t.submit()},processData:!1,contentType:!1,cache:!1},_refreshOptionsList:["namespace","dropZone","fileInput","multipart","forceIframeTransport"],_BitrateTimer:function(){this.timestamp=+(new Date),this.loaded=0,this.bitrate=0,this.getBitrate=function(e,t,n){var r=e-this.timestamp;if(!this.bitrate||!n||r>n)this.bitrate=(t-this.loaded)*(1e3/r)*8,this.loaded=t,this.timestamp=e;return this.bitrate}},_isXHRUpload:function(t){return!t.forceIframeTransport&&(!t.multipart&&e.support.xhrFileUpload||e.support.xhrFormDataFileUpload)},_getFormData:function(t){var n;return typeof t.formData=="function"?t.formData(t.form):e.isArray(t.formData)?t.formData:t.formData?(n=[],e.each(t.formData,function(e,t){n.push({name:e,value:t})}),n):[]},_getTotal:function(t){var n=0;return e.each(t,function(e,t){n+=t.size||1}),n},_onProgress:function(e,t){if(e.lengthComputable){var n=+(new Date),r,i;if(t._time&&t.progressInterval&&n-t._time<t.progressInterval&&e.loaded!==e.total)return;t._time=n,r=t.total||this._getTotal(t.files),i=parseInt(e.loaded/e.total*(t.chunkSize||r),10)+(t.uploadedBytes||0),this._loaded+=i-(t.loaded||t.uploadedBytes||0),t.lengthComputable=!0,t.loaded=i,t.total=r,t.bitrate=t._bitrateTimer.getBitrate(n,i,t.bitrateInterval),this._trigger("progress",e,t),this._trigger("progressall",e,{lengthComputable:!0,loaded:this._loaded,total:this._total,bitrate:this._bitrateTimer.getBitrate(n,this._loaded,t.bitrateInterval)})}},_initProgressListener:function(t){var n=this,r=t.xhr?t.xhr():e.ajaxSettings.xhr();r.upload&&(e(r.upload).bind("progress",function(e){var r=e.originalEvent;e.lengthComputable=r.lengthComputable,e.loaded=r.loaded,e.total=r.total,n._onProgress(e,t)}),t.xhr=function(){return r})},_initXHRData:function(t){var n,r=t.files[0],i=t.multipart||!e.support.xhrFileUpload,s=t.paramName[0];if(!i||t.blob)t.headers=e.extend(t.headers,{"X-File-Name":r.name,"X-File-Type":r.type,"X-File-Size":r.size}),t.blob?i||(t.contentType="application/octet-stream",t.data=t.blob):(t.contentType=r.type,t.data=r);i&&e.support.xhrFormDataFileUpload&&(t.postMessage?(n=this._getFormData(t),t.blob?n.push({name:s,value:t.blob}):e.each(t.files,function(e,r){n.push({name:t.paramName[e]||s,value:r})})):(t.formData instanceof FormData?n=t.formData:(n=new FormData,e.each(this._getFormData(t),function(e,t){n.append(t.name,t.value)})),t.blob?n.append(s,t.blob,r.name):e.each(t.files,function(e,r){r instanceof Blob&&n.append(t.paramName[e]||s,r,r.name)})),t.data=n),t.blob=null},_initIframeSettings:function(t){t.dataType="iframe "+(t.dataType||""),t.formData=this._getFormData(t),t.redirect&&e("<a></a>").prop("href",t.url).prop("host")!==location.host&&t.formData.push({name:t.redirectParamName||"redirect",value:t.redirect})},_initDataSettings:function(e){this._isXHRUpload(e)?(this._chunkedUpload(e,!0)||(e.data||this._initXHRData(e),this._initProgressListener(e)),e.postMessage&&(e.dataType="postmessage "+(e.dataType||""))):this._initIframeSettings(e,"iframe")},_getParamName:function(t){var n=e(t.fileInput),r=t.paramName;return r?e.isArray(r)||(r=[r]):(r=[],n.each(function(){var t=e(this),n=t.prop("name")||"files[]",i=(t.prop("files")||[1]).length;while(i)r.push(n),i-=1}),r.length||(r=[n.prop("name")||"files[]"])),r},_initFormSettings:function(t){if(!t.form||!t.form.length)t.form=e(t.fileInput.prop("form"));t.paramName=this._getParamName(t),t.url||(t.url=t.form.prop("action")||location.href),t.type=(t.type||t.form.prop("method")||"").toUpperCase(),t.type!=="POST"&&t.type!=="PUT"&&(t.type="POST")},_getAJAXSettings:function(t){var n=e.extend({},this.options,t);return this._initFormSettings(n),this._initDataSettings(n),n},_enhancePromise:function(e){return e.success=e.done,e.error=e.fail,e.complete=e.always,e},_getXHRPromise:function(t,n,r){var i=e.Deferred(),s=i.promise();return n=n||this.options.context||s,t===!0?i.resolveWith(n,r):t===!1&&i.rejectWith(n,r),s.abort=i.promise,this._enhancePromise(s)},_chunkedUpload:function(t,n){var r=this,i=t.files[0],s=i.size,o=t.uploadedBytes=t.uploadedBytes||0,u=t.maxChunkSize||s,a=i.webkitSlice||i.mozSlice||i.slice,f,l,c,h;return!(this._isXHRUpload(t)&&a&&(o||u<s))||t.data?!1:n?!0:o>=s?(i.error="uploadedBytes",this._getXHRPromise(!1,t.context,[null,"error",i.error])):(l=Math.ceil((s-o)/u),f=function(n){return n?f(n-=1).pipe(function(){var s=e.extend({},t);return s.blob=a.call(i,o+n*u,o+(n+1)*u),s.chunkSize=s.blob.size,r._initXHRData(s),r._initProgressListener(s),c=(e.ajax(s)||r._getXHRPromise(!1,s.context)).done(function(){s.loaded||r._onProgress(e.Event("progress",{lengthComputable:!0,loaded:s.chunkSize,total:s.chunkSize}),s),t.uploadedBytes=s.uploadedBytes+=s.chunkSize}),c}):r._getXHRPromise(!0,t.context)},h=f(l),h.abort=function(){return c.abort()},this._enhancePromise(h))},_beforeSend:function(e,t){this._active===0&&(this._trigger("start"),this._bitrateTimer=new this._BitrateTimer),this._active+=1,this._loaded+=t.uploadedBytes||0,this._total+=this._getTotal(t.files)},_onDone:function(t,n,r,i){this._isXHRUpload(i)||this._onProgress(e.Event("progress",{lengthComputable:!0,loaded:1,total:1}),i),i.result=t,i.textStatus=n,i.jqXHR=r,this._trigger("done",null,i)},_onFail:function(e,t,n,r){r.jqXHR=e,r.textStatus=t,r.errorThrown=n,this._trigger("fail",null,r),r.recalculateProgress&&(this._loaded-=r.loaded||r.uploadedBytes||0,this._total-=r.total||this._getTotal(r.files))},_onAlways:function(e,t,n,r){this._active-=1,r.textStatus=t,n&&n.always?(r.jqXHR=n,r.result=e):(r.jqXHR=e,r.errorThrown=n),this._trigger("always",null,r),this._active===0&&(this._trigger("stop"),this._loaded=this._total=0,this._bitrateTimer=null)},_onSend:function(t,n){var r=this,i,s,o,u=r._getAJAXSettings(n),a=function(n,s){return r._sending+=1,u._bitrateTimer=new r._BitrateTimer,i=i||(n!==!1&&r._trigger("send",t,u)!==!1&&(r._chunkedUpload(u)||e.ajax(u))||r._getXHRPromise(!1,u.context,s)).done(function(e,t,n){r._onDone(e,t,n,u)}).fail(function(e,t,n){r._onFail(e,t,n,u)}).always(function(e,t,n){r._sending-=1,r._onAlways(e,t,n,u);if(u.limitConcurrentUploads&&u.limitConcurrentUploads>r._sending){var i=r._slots.shift();while(i){if(!i.isRejected()){i.resolve();break}i=r._slots.shift()}}}),i};return this._beforeSend(t,u),this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending?(this.options.limitConcurrentUploads>1?(s=e.Deferred(),this._slots.push(s),o=s.pipe(a)):o=this._sequence=this._sequence.pipe(a,a),o.abort=function(){var e=[undefined,"abort","abort"];return i?i.abort():(s&&s.rejectWith(e),a(!1,e))},this._enhancePromise(o)):a()},_onAdd:function(t,n){var r=this,i=!0,s=e.extend({},this.options,n),o=s.limitMultiFileUploads,u=this._getParamName(s),a,f,l,c;if(!s.singleFileUploads&&!o||!this._isXHRUpload(s))l=[n.files],a=[u];else if(!s.singleFileUploads&&o){l=[],a=[];for(c=0;c<n.files.length;c+=o)l.push(n.files.slice(c,c+o)),f=u.slice(c,c+o),f.length||(f=u),a.push(f)}else a=u;return n.originalFiles=n.files,e.each(l||n.files,function(s,o){var u=e.extend({},n);return u.files=l?o:[o],u.paramName=a[s],u.submit=function(){return u.jqXHR=this.jqXHR=r._trigger("submit",t,this)!==!1&&r._onSend(t,this),this.jqXHR},i=r._trigger("add",t,u)}),i},_normalizeFile:function(e,t){t.name===undefined&&t.size===undefined&&(t.name=t.fileName,t.size=t.fileSize)},_replaceFileInput:function(t){var n=t.clone(!0);e("<form></form>").append(n)[0].reset(),t.after(n).detach(),e.cleanData(t.unbind("remove")),this.options.fileInput=this.options.fileInput.map(function(e,r){return r===t[0]?n[0]:r}),t[0]===this.element[0]&&(this.element=n)},_getFileInputFiles:function(t){t=e(t);var n=e.each(e.makeArray(t.prop("files")),this._normalizeFile),r;if(!n.length){r=t.prop("value");if(!r)return[];n=[{name:r.replace(/^.*\\/,"")}]}return n},_onChange:function(t){var n=t.data.fileupload,r={fileInput:e(t.target),form:e(t.target.form)};r.files=n._getFileInputFiles(r.fileInput),n.options.replaceFileInput&&n._replaceFileInput(r.fileInput);if(n._trigger("change",t,r)===!1||n._onAdd(t,r)===!1)return!1},_onPaste:function(t){var n=t.data.fileupload,r=t.originalEvent.clipboardData,i=r&&r.items||[],s={files:[]};e.each(i,function(e,t){var n=t.getAsFile&&t.getAsFile();n&&s.files.push(n)});if(n._trigger("paste",t,s)===!1||n._onAdd(t,s)===!1)return!1},_onDrop:function(t){var n=t.data.fileupload,r=t.dataTransfer=t.originalEvent.dataTransfer,i={files:e.each(e.makeArray(r&&r.files),n._normalizeFile)};if(n._trigger("drop",t,i)===!1||n._onAdd(t,i)===!1)return!1;t.preventDefault()},_onDragOver:function(e){var t=e.data.fileupload,n=e.dataTransfer=e.originalEvent.dataTransfer;if(t._trigger("dragover",e)===!1)return!1;n&&(n.dropEffect="copy"),e.preventDefault()},_initEventHandlers:function(){var e=this.options.namespace;this._isXHRUpload(this.options)&&this.options.dropZone.bind("dragover."+e,{fileupload:this},this._onDragOver).bind("drop."+e,{fileupload:this},this._onDrop).bind("paste."+e,{fileupload:this},this._onPaste),this.options.fileInput.bind("change."+e,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var e=this.options.namespace;this.options.dropZone.unbind("dragover."+e,this._onDragOver).unbind("drop."+e,this._onDrop).unbind("paste."+e,this._onPaste),this.options.fileInput.unbind("change."+e,this._onChange)},_setOption:function(t,n){var r=e.inArray(t,this._refreshOptionsList)!==-1;r&&this._destroyEventHandlers(),e.Widget.prototype._setOption.call(this,t,n),r&&(this._initSpecialOptions(),this._initEventHandlers())},_initSpecialOptions:function(){var t=this.options;t.fileInput===undefined?t.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file"):t.fileInput instanceof e||(t.fileInput=e(t.fileInput)),t.dropZone instanceof e||(t.dropZone=e(t.dropZone))},_create:function(){var t=this.options;e.extend(t,e(this.element[0].cloneNode(!1)).data()),t.namespace=t.namespace||this.widgetName,this._initSpecialOptions(),this._slots=[],this._sequence=this._getXHRPromise(!0),this._sending=this._active=this._loaded=this._total=0,this._initEventHandlers()},destroy:function(){this._destroyEventHandlers(),e.Widget.prototype.destroy.call(this)},enable:function(){e.Widget.prototype.enable.call(this),this._initEventHandlers()},disable:function(){this._destroyEventHandlers(),e.Widget.prototype.disable.call(this)},add:function(t){if(!t||this.options.disabled)return;t.fileInput&&!t.files?t.files=this._getFileInputFiles(t.fileInput):t.files=e.each(e.makeArray(t.files),this._normalizeFile),this._onAdd(null,t)},send:function(t){if(t&&!this.options.disabled){t.fileInput&&!t.files?t.files=this._getFileInputFiles(t.fileInput):t.files=e.each(e.makeArray(t.files),this._normalizeFile);if(t.files.length)return this._onSend(null,t)}return this._getXHRPromise(!1,t&&t.context)}})});